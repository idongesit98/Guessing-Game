<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Guessing Game</title>
  <style>
    /* Simple styling for chat and controls */
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 5px; }
    #messageInput { width: 80%; }
  </style>
</head>
<body>
  <h1>Guessing Game</h1>
  
  <!-- Chat display -->
  <div id="chat"></div>
  
  <!-- Chat input -->
  <input type="text" id="messageInput" placeholder="Type a message or command" />
  <button id="sendBtn">Send</button>
  
  <hr/>
  
  <div id="gameControls">
    <!-- Session controls -->
    <button id="createSessionBtn">Create Session (Game Master)</button>
    <input type="text" id="sessionIdInput" placeholder="Session ID to join" />
    <button id="joinSessionBtn">Join Session</button>
    <br/><br/>
    <!-- Controls visible only for game master -->
    <div id="masterControls" style="display:none;">
      <input type="text" id="usernameInput" placeholder="Your username" />
      <br/><br/>
      <input type="text" id="questionInput" placeholder="Enter question" />
      <input type="text" id="answerInput" placeholder="Enter answer" />
      <button id="setQuestionBtn">Set Question</button>
      <button id="startGameBtn">Start Game</button>
    </div>
  </div>
  
  <!-- Include Socket.io client library -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    
    const createSessionBtn = document.getElementById('createSessionBtn');
    const joinSessionBtn = document.getElementById('joinSessionBtn');
    const sessionIdInput = document.getElementById('sessionIdInput');
    const masterControls = document.getElementById('masterControls');
    const usernameInput = document.getElementById('usernameInput');
    const questionInput = document.getElementById('questionInput');
    const answerInput = document.getElementById('answerInput');
    const setQuestionBtn = document.getElementById('setQuestionBtn');
    const startGameBtn = document.getElementById('startGameBtn');
    
    let currentSessionId = '';
    
    // Helper to display messages in the chat div.
    function addMessage(message) {
      const p = document.createElement('p');
      p.innerText = message;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    }
    
    // Send a chat message.
    sendBtn.addEventListener('click', () => {
      const msg = messageInput.value;
      socket.emit('chatMessage', { msg });
      messageInput.value = '';
    });
    
    // Create session (as game master)
    createSessionBtn.addEventListener('click', () => {
      const username = usernameInput.value || 'GameMaster';
      socket.emit('createSession', { username });
    });
    
    // Join an existing session
    joinSessionBtn.addEventListener('click', () => {
      const sessionId = sessionIdInput.value;
      const username = usernameInput.value || 'Player';
      socket.emit('joinSession', { sessionId, username });
    });
    
    // Set the question and answer (game master only)
    setQuestionBtn.addEventListener('click', () => {
      const question = questionInput.value;
      const answer = answerInput.value;
      socket.emit('setQuestion', { question, answer });
    });
    
    // Start the game session (game master only)
    startGameBtn.addEventListener('click', () => {
      socket.emit('startGame');
    });
    
    // Handle session creation event.
    socket.on('sessionCreated', (data) => {
      currentSessionId = data.sessionId;
      addMessage(`Session created with ID: ${currentSessionId}`);
      masterControls.style.display = 'block';
    });
    
    // Update session info: number of players and their scores.
    socket.on('sessionUpdate', (data) => {
      addMessage(`Players connected: ${data.playerCount}`);
      let playersInfo = 'Players: ';
      data.players.forEach(player => {
        playersInfo += `${player.username}(${player.score}) `;
      });
      addMessage(playersInfo);
    });
    
    // When the game starts, display the question.
    socket.on('gameStarted', (data) => {
      addMessage(`Game Started! Question: ${data.question}`);
    });
    
    // Handle game end events (either correct guess or time expired).
    socket.on('gameEnded', (data) => {
      addMessage(`Game Ended: ${data.msg}`);
      if(data.answer) {
          addMessage(`The answer was: ${data.answer}`);
      }
    });
    
    // Display generic messages.
    socket.on('message', (data) => {
      addMessage(data.msg);
    });
    
    // Display chat messages.
    socket.on('chatMessage', (data) => {
      addMessage(`${data.username}: ${data.msg}`);
    });
    
    // Display error messages.
    socket.on('errorMsg', (data) => {
      addMessage(`Error: ${data.msg}`);
    });
  </script>
</body>
</html>
